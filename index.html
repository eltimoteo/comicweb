<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicDB - VSCode Mode</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Fonts: Atkinson Hyperlegible Mono (User Request) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-editor: #1e1e1e;
            --bg-sidebar: #252526;
            --bg-activity: #333333;
            --bg-panel: #2d2d2d;
            /* Panel headers, search container */
            --bg-input: #3c3c3c;
            /* Dropdowns, Inputs */
            --bg-item-hover: #2a2d2e;
            --bg-item-active: #37373d;
            --border: #3e3e42;
            --accent: #007acc;
            --text-main: #d4d4d4;
            --text-muted: #858585;
            --text-active: #ffffff;

            /* Syntax Highlighting */
            --keyword: #569cd6;
            /* Blue */
            --string: #ce9178;
            /* Orange/Brown */
            --function: #dcdcaa;
            /* Yellow */
            --comment: #6a9955;
            /* Green */
            --number: #b5cea8;
            /* Light Green */
            --type: #4ec9b0;
            /* Teal */
            --variable: #9cdcfe;
            /* Light Blue */
        }

        body {
            font-family: 'Atkinson Hyperlegible Mono', monospace;
            background-color: var(--bg-editor);
            color: var(--text-main);
        }

        /* Splash Screen Typing Cursor */
        .cursor::after {
            content: '█';
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-editor);
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }

        /* Utilities */
        .vscode-border {
            border: 1px solid var(--border);
        }

        .vscode-card {
            background-color: var(--bg-sidebar);
        }

        .vscode-input {
            background-color: var(--activity);
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .vscode-input:focus {
            border-color: var(--accent);
            outline: none;
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">

    <!-- SPLASH SCREEN -->
    <div id="splash"
        class="fixed inset-0 z-50 bg-[var(--bg-editor)] flex items-center justify-center font-mono text-lg">
        <div class="w-full max-w-2xl p-10">
            <div id="terminal-text" class="text-green-500 mb-2"></div>
            <div class="text-[var(--text-muted)] text-sm mt-4 hidden" id="splash-footer">Initializing environment...
                v2.56.0</div>
        </div>
    </div>

    <!-- VSCode Title Bar (Fake) -->
    <div class="h-8 bg-[var(--bg-input)] flex items-center justify-between px-4 text-xs select-none">
        <div class="flex gap-4">
            <span class="font-bold">ComicDB.workspace-v2.56.0</span>
            <span class="text-[var(--text-muted)]">File</span>
            <span class="text-[var(--text-muted)]">Edit</span>
            <span class="text-[var(--text-muted)]">Selection</span>
            <span class="text-[var(--text-muted)]">View</span>
        </div>

        <!-- Command Palette / Search (Centered) -->
        <div class="flex-1 max-w-xl mx-4 relative">
            <div
                class="bg-[var(--bg-panel)] rounded-md border border-[var(--border)] flex items-center px-2 py-0.5 w-full">
                <i class="fa-solid fa-search text-[var(--text-muted)] text-xs mr-2"></i>
                <input type="text" id="searchInput" placeholder="Search (Cmd+F)"
                    class="bg-transparent border-none text-[var(--text-main)] text-xs w-full focus:outline-none placeholder-gray-500">
            </div>
        </div>

        <div class="flex gap-3 text-[var(--text-muted)]">
            <i class="fa-solid fa-window-minimize hover:text-white"></i>
            <i class="fa-regular fa-square hover:text-white"></i>
            <i class="fa-solid fa-xmark hover:text-white"></i>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Activity Bar (Left Sidebar) -->
        <div
            class="w-12 bg-[var(--bg-activity)] flex flex-col items-center py-4 gap-6 text-[var(--text-muted)] text-xl border-r border-[var(--bg-sidebar)]">
            <i id="icon-files"
                class="fa-solid fa-copy text-white border-l-2 border-white pl-3 pr-4 py-1 activity-icon cursor-pointer"></i>
            <!-- Explorer -->
            <i id="icon-search"
                class="fa-solid fa-search hover:text-white transition cursor-pointer activity-icon pl-3 pr-4 py-1"></i>
            <i id="icon-git"
                class="fa-solid fa-code-branch hover:text-white transition cursor-pointer activity-icon pl-3 pr-4 py-1"></i>
            <i id="icon-debug"
                class="fa-solid fa-bug hover:text-white transition cursor-pointer activity-icon pl-3 pr-4 py-1"></i>
            <div class="flex-1"></div>
            <i id="icon-settings"
                class="fa-solid fa-gear hover:text-white transition cursor-pointer mb-2 activity-icon pl-3 pr-4 py-1"></i>
        </div>

        <!-- Sidebar (File Explorer) -->
        <div id="sidebar-panel"
            class="w-64 bg-[var(--bg-sidebar)] flex flex-col text-sm border-r border-[var(--bg-editor)] hidden md:flex">
            <div
                class="px-4 py-2 flex items-center justify-between uppercase text-xs font-bold text-[var(--text-muted)] tracking-wider">
                <span>Explorer</span>
                <i id="btn-collapse-explorer" class="fa-solid fa-chevron-left hover:text-white cursor-pointer"
                    title="Collapse Explorer"></i>
            </div>

            <!-- Open Editors -->
            <div class="px-4 py-1 flex items-center gap-1 bg-[var(--bg-item-active)] text-white">
                <i class="fa-solid fa-chevron-down text-[10px]"></i>
                <span class="font-bold">OPEN COMICS</span>
            </div>

            <!-- Folder Structure (Tabs) -->
            <div class="mt-2 pl-2">
                <div onclick="loadSheet('marvel')" id="btn-marvel"
                    class="cursor-pointer px-2 py-1 flex items-center gap-2 hover:bg-[var(--bg-item-hover)] text-[var(--text-main)]">
                    <i class="fa-brands fa-js text-[#f1e05a]"></i> <!-- JS Icon for marvel -->
                    <span>marvel_comics.js</span>
                    <span id="badge-marvel"
                        class="ml-auto text-[10px] bg-[var(--accent)] text-white px-1.5 rounded-full hidden">A</span>
                </div>
                <div onclick="loadSheet('dc')" id="btn-dc"
                    class="cursor-pointer px-2 py-1 flex items-center gap-2 hover:bg-[var(--bg-item-hover)] text-[var(--text-main)]">
                    <i class="fa-brands fa-js text-[#f1e05a]"></i>
                    <span>dc_universe.js</span>
                </div>
                <div onclick="loadSheet('others')" id="btn-others"
                    class="cursor-pointer px-2 py-1 flex items-center gap-2 hover:bg-[var(--bg-item-hover)] text-[var(--text-main)]">
                    <i class="fa-solid fa-file-code text-blue-400"></i>
                    <span>indie_reads.json</span>
                </div>
            </div>

            <div class="mt-6 px-4 py-2 uppercase text-xs font-bold text-[var(--text-muted)] tracking-wider">Properties
            </div>
            <!-- Filters in Sidebar -->
            <div class="px-4 py-2 gap-3 flex flex-col">
                <select id="readFilter"
                    class="bg-[var(--bg-input)] text-[var(--text-main)] text-xs p-1 border border-[var(--border)] outline-none">
                    <option value="all">filter: all</option>
                    <option value="read">filter: read</option>
                    <option value="unread">filter: unread</option>
                </select>

                <select id="sortSelect"
                    class="bg-[var(--bg-input)] text-[var(--text-main)] text-xs p-1 border border-[var(--border)] outline-none">
                    <option value="title">sort: title</option>
                    <option value="year">sort: year</option>
                    <option value="rating">sort: rating</option>
                </select>

                <button id="orderBtn" class="text-left text-xs text-[var(--keyword)] hover:underline">
                    <i class="fa-solid fa-arrow-down-a-z"></i> toggle: direction
                </button>
            </div>
        </div>

        <!-- Editor Area (Grid) -->
        <div class="flex-1 flex flex-col bg-[var(--bg-editor)] overflow-hidden">
            <!-- Tabs Header -->
            <div
                class="h-9 bg-[var(--bg-panel)] flex items-center overflow-x-auto text-sm border-b border-[var(--border)]">
                <div id="tab-main" onclick="loadSheet(currentTab)"
                    class="cursor-pointer bg-[var(--bg-editor)] text-[var(--text-main)] px-4 h-full flex items-center border-t-2 border-[var(--accent)] gap-2 pr-8 relative">
                    <i class="fa-brands fa-js text-yellow-500"></i>
                    <span>main.js</span>
                    <i class="fa-solid fa-xmark text-[var(--text-muted)] hover:text-white absolute right-2 text-xs"></i>
                </div>
                <!-- Readme Tab -->
                <div id="tab-readme" onclick="loadReadme()"
                    class="cursor-pointer bg-[var(--bg-panel)] text-[var(--text-muted)] px-4 h-full flex items-center gap-2 border-r border-[var(--bg-sidebar)]">
                    <i class="fa-solid fa-file-lines text-blue-400"></i>
                    <span>README.md</span>
                </div>
            </div>

            <!-- Breadcrumbs -->
            <div class="h-6 flex items-center px-4 text-xs text-[var(--text-muted)] gap-1 bg-[var(--bg-editor)]">
                <span>src</span> <i class="fa-solid fa-chevron-right text-[10px]"></i>
                <span>components</span> <i class="fa-solid fa-chevron-right text-[10px]"></i>
                <span id="crumb-active" class="text-white">marvel_comics.js</span>
                <span id="statsBar" class="ml-auto text-xs text-[var(--text-muted)]">Loading...</span>
            </div>

            <!-- Grid Content -->
            <!-- README / About Me Content -->
            <div id="readme-container"
                class="hidden flex-1 overflow-y-auto p-8 font-serif bg-[var(--bg-editor)] text-[var(--text-main)]">
                <div class="max-w-3xl mx-auto">
                    <h1 class="text-4xl font-bold mb-6 border-b border-[var(--border)] pb-4">About Me</h1>

                    <div class="flex flex-col md:flex-row gap-6 mb-8 items-center md:items-start">
                        <!-- Profile Image Placeholder -->
                        <div class="shrink-0 group relative">
                            <div
                                class="w-40 h-40 rounded-full border-4 border-[var(--accent)] shadow-xl overflow-hidden bg-[var(--bg-activity)] flex items-center justify-center">
                                <!-- Replace 'src' with your image URL -->
                                <img src="IMG_0178.heic" alt="Profile"
                                    class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition duration-300">
                            </div>
                        </div>

                        <div class="flex-1">
                            <p class="mb-4 text-lg leading-relaxed mt-2">
                                Hi, I'm <span class="text-[var(--accent)] font-bold">Timothy</span>. Welcome to my comic
                                collection page!
                            </p>
                            <p class="mb-4 text-lg leading-relaxed">
                                I built this application to catalog my growing collection of Marvel and DC comics.
                                This is built upon and directly linked to my Google Sheets database, where I intially
                                stored my
                                data.
                            </p>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold mt-8 mb-4">Tech Stack Info</h2>
                    <ul class="list-disc pl-6 space-y-2 mb-8">
                        <li><strong>Frontend:</strong> HTML5, Tailwind CSS, Vanilla JS</li>
                        <li><strong>Data:</strong> Google Sheets CSV API + PapaParse</li>
                        <li><strong>Design:</strong> VSCode Dark+ Theme (Custom Implementation)</li>
                    </ul>
                    <div class="p-4 bg-[var(--bg-item-active)] rounded-lg border-l-4 border-[var(--accent)]">
                        <p class="italic">"With great power comes great responsibility."</p>
                        <p class="text-right text-sm mt-2">- Uncle Ben</p>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 md:p-6" id="scroll-container">
                <div id="loading" class="hidden text-center py-10">
                    <div class="text-[var(--keyword)]">Loading modules...</div>
                </div>

                <div id="comicGrid"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                    <!-- Cards -->
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="h-6 bg-[var(--accent)] flex items-center justify-between px-3 text-[11px] text-white">
        <div class="flex gap-4">
            <span><i id="icon-git" class="fa-solid fa-code-branch text-[10px]"></i> main*</span>
            <span><i class="fa-regular fa-circle-xmark"></i> 0</span>
            <span><i class="fa-solid fa-triangle-exclamation"></i> 0</span>
        </div>
        <div class="flex gap-4">
            <span>Ln 12, Col 42</span>
            <span>UTF-8</span>
            <span>JavaScript</span>
            <span><i class="fa-regular fa-bell"></i></span>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="hidden absolute bottom-12 left-12 w-64 bg-[var(--bg-sidebar)] border border-[var(--border)] shadow-2xl z-50 text-sm">
        <div
            class="p-2 text-xs text-[var(--text-muted)] font-bold uppercase tracking-wider border-b border-[var(--border)]">
            Preferences</div>
        <div class="p-2">
            <div class="mb-2 text-[var(--text-main)]">Color Theme</div>
            <select id="themeSelect"
                class="w-full bg-[var(--bg-input)] text-[var(--text-main)] p-1 border border-[var(--border)] outline-none hover:border-[var(--accent)]">
                <option value="dark-plus">Dark+ (Default)</option>
                <option value="light-plus">Light+ (Standard)</option>
                <option value="monokai">Monokai</option>
                <option value="abyss">Abyss</option>
                <option value="solarized">Solarized Light</option>
            </select>
        </div>
        <div
            class="border-t border-[var(--border)] p-2 hover:bg-[var(--bg-item-hover)] cursor-pointer text-[var(--text-main)] flex items-center justify-between group">
            <span>Keyboard Shortcuts</span>
            <span class="text-xs text-[var(--text-muted)] group-hover:text-[var(--text-active)]">⌘K ⌘S</span>
        </div>
    </div>

    <script>
        // --- DATA CONFIG ---
        const sheetConfig = {
            marvel: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTFTPLKwr0aJgqiW3fPIbp5SvHLSDu6mPGnILzw9uMBKWfw7VdNykUY4NLiGNcb4dU3VI7XLkO8iSqX/pub?gid=61223904&single=true&output=csv",
            dc: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTFTPLKwr0aJgqiW3fPIbp5SvHLSDu6mPGnILzw9uMBKWfw7VdNykUY4NLiGNcb4dU3VI7XLkO8iSqX/pub?gid=0&single=true&output=csv",
            others: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTFTPLKwr0aJgqiW3fPIbp5SvHLSDu6mPGnILzw9uMBKWfw7VdNykUY4NLiGNcb4dU3VI7XLkO8iSqX/pub?gid=1684289763&single=true&output=csv"
        };

        // --- THEMES ---
        const themes = {
            'dark-plus': {
                '--bg-editor': '#1e1e1e', '--bg-sidebar': '#252526', '--bg-activity': '#333333',
                '--bg-panel': '#2d2d2d', '--bg-input': '#3c3c3c', '--bg-item-hover': '#2a2d2e', '--bg-item-active': '#37373d',
                '--border': '#3e3e42', '--accent': '#007acc', '--text-main': '#d4d4d4', '--text-muted': '#858585',
                '--keyword': '#569cd6', '--string': '#ce9178', '--function': '#dcdcaa', '--number': '#b5cea8', '--type': '#4ec9b0', '--variable': '#9cdcfe'
            },
            'light-plus': {
                '--bg-editor': '#ffffff', '--bg-sidebar': '#f3f3f3', '--bg-activity': '#2c2c2c',
                '--bg-panel': '#f3f3f3', '--bg-input': '#ffffff', '--bg-item-hover': '#e8e8e8', '--bg-item-active': '#007acc33',
                '--border': '#e4e4e4', '--accent': '#007acc', '--text-main': '#333333', '--text-muted': '#666666', '--text-active': '#333333',
                '--keyword': '#0000ff', '--string': '#a31515', '--function': '#795e26', '--number': '#098658', '--type': '#267f99', '--variable': '#001080'
            },
            'monokai': {
                '--bg-editor': '#272822', '--bg-sidebar': '#1e1f1c', '--bg-activity': '#171814',
                '--bg-panel': '#1e1f1c', '--bg-input': '#414339', '--bg-item-hover': '#3e3d32', '--bg-item-active': '#75715e',
                '--border': '#1e1f1c', '--accent': '#f92672', '--text-main': '#f8f8f2', '--text-muted': '#75715e',
                '--keyword': '#f92672', '--string': '#e6db74', '--function': '#a6e22e', '--number': '#ae81ff', '--type': '#66d9ef', '--variable': '#fd971f'
            },
            'abyss': {
                '--bg-editor': '#000c18', '--bg-sidebar': '#051336', '--bg-activity': '#102a5f',
                '--bg-panel': '#0b1c42', '--bg-input': '#223355', '--bg-item-hover': '#112244', '--bg-item-active': '#1e3a6e',
                '--border': '#2d3664', '--accent': '#77085a', '--text-main': '#6688c2', '--text-muted': '#3b5588',
                '--keyword': '#225588', '--string': '#22aa44', '--function': '#ddbb88', '--number': '#d2dfee', '--type': '#9966b8', '--variable': '#77085a'
            },
            'solarized': {
                '--bg-editor': '#fdf6e3', '--bg-sidebar': '#eee8d5', '--bg-activity': '#93a1a1',
                '--bg-panel': '#e6dfc4', '--bg-input': '#fdf6e3', '--bg-item-hover': '#d5ccb4', '--bg-item-active': '#d3368222',
                '--border': '#d3cbb7', '--accent': '#2aa198', '--text-main': '#586e75', '--text-muted': '#586e75', '--text-active': '#002b36',
                '--keyword': '#859900', '--string': '#cb4b16', '--function': '#b58900', '--number': '#2aa198', '--type': '#268bd2', '--variable': '#6c71c4'
            }
        };

        let currentData = [];
        let currentTab = 'marvel';
        let isDescending = false;

        // --- SPLASH SCREEN LOGIC ---
        async function runSplash() {
            const terminal = document.getElementById('terminal-text');
            const footer = document.getElementById('splash-footer');
            const commands = [
                "> npm install comic-db",
                "[SUCCESS] Installed 142 packages in 0.4s",
                "> npm run dev",
                "> Server ready at localhost:3000..."
            ];

            for (const cmd of commands) {
                const p = document.createElement('div');
                p.className = cmd.startsWith(">") ? "text-white" : "text-gray-400 pl-4";
                terminal.appendChild(p);

                // Typing effect for commands
                if (cmd.startsWith(">")) {
                    p.innerHTML = "> <span class='cursor'></span>";
                    const text = cmd.substring(2);
                    for (let i = 0; i < text.length; i++) {
                        p.querySelector('span').textContent = text.substring(0, i + 1); // Remove cursor for now or keep it?
                        p.innerHTML = `> ${text.substring(0, i + 1)}<span class='cursor'></span>`;
                        await new Promise(r => setTimeout(r, 20));
                    }
                    p.querySelector('.cursor').remove();
                } else {
                    p.innerText = cmd;
                    await new Promise(r => setTimeout(r, 150));
                }
                await new Promise(r => setTimeout(r, 100)); // Faster startup
            }

            footer.classList.remove('hidden');
            setTimeout(() => {
                const splash = document.getElementById('splash');
                splash.style.opacity = '0';
                splash.style.transition = 'opacity 0.4s';
                setTimeout(() => splash.remove(), 400);
            }, 600);
        }

        document.addEventListener('keydown', (e) => {
            // CMD+F / CTRL+F -> Focus Search
            if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            // CMD+P / CTRL+P -> Focus Search (User habit)
            if ((e.metaKey || e.ctrlKey) && e.key === 'p') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Init Theme (to set initial vars if strict mode)
            const theme = themes['dark-plus'];
            Object.keys(theme).forEach(key => {
                document.documentElement.style.setProperty(key, theme[key]);
            });

            runSplash();
            loadSheet('marvel');

            // --- FUNCTIONAL SIDEBAR ---
            const sidebarExplorer = document.getElementById('sidebar-panel');

            // Files Icon -> Toggle Explorer
            document.getElementById('icon-files').addEventListener('click', (e) => {
                // Check computed style or inline style for robustness
                const isHidden = sidebarExplorer.style.display === 'none';
                const isAlreadyActive = document.getElementById('icon-files').classList.contains('border-l-2');

                // Reset all icons first
                document.querySelectorAll('.activity-icon').forEach(i => i.classList.remove('text-[var(--text-active)]', 'border-l-2', 'border-[var(--text-active)]'));

                if (!isHidden && isAlreadyActive) {
                    // Only collapse if it was already the active tab
                    sidebarExplorer.style.display = 'none';
                } else {
                    // Switch to files view
                    sidebarExplorer.style.display = 'flex';
                    document.getElementById('icon-files').classList.add('text-[var(--text-active)]', 'border-l-2', 'border-[var(--text-active)]');
                }
            });

            // Collapse from Explorer Header
            document.getElementById('btn-collapse-explorer').addEventListener('click', () => {
                sidebarExplorer.style.display = 'none';
                document.querySelectorAll('.activity-icon').forEach(i => i.classList.remove('text-[var(--text-active)]', 'border-l-2', 'border-[var(--text-active)]'));
            });

            // Search Icon -> Focus Search
            document.getElementById('icon-search').addEventListener('click', () => {
                document.getElementById('searchInput').focus();
                document.querySelectorAll('.activity-icon').forEach(i => i.classList.remove('text-[var(--text-active)]', 'border-l-2', 'border-[var(--text-active)]'));
                document.getElementById('icon-search').classList.add('text-[var(--text-active)]', 'border-l-2', 'border-[var(--text-active)]');
            });

            // Git Icon
            document.getElementById('icon-git').addEventListener('click', () => {
                alert("Source Control: No providers registered. (It's a static site!)");
            });

            // Debug Icon
            document.getElementById('icon-debug').addEventListener('click', () => {
                const debugInfo = {
                    currentTab,
                    totalItems: currentData.length,
                    activeTheme: document.getElementById('themeSelect').value
                };
                alert('DEBUG CONTEXT:\\n' + JSON.stringify(debugInfo, null, 2));
            });

            // Settings Icon -> Toggle Modal
            document.getElementById('icon-settings').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('settings-modal').classList.toggle('hidden');
            });

            // Close modal on outside click
            document.addEventListener('click', (e) => {
                const modal = document.getElementById('settings-modal');
                const btn = document.getElementById('icon-settings');
                if (!modal.contains(e.target) && !btn.contains(e.target)) {
                    modal.classList.add('hidden');
                }
            });

            // Theme Switcher
            document.getElementById('themeSelect').addEventListener('change', (e) => {
                const theme = themes[e.target.value];
                Object.keys(theme).forEach(key => {
                    document.documentElement.style.setProperty(key, theme[key]);
                });
            });

            // Main Listeners
            document.getElementById('searchInput').addEventListener('input', renderComics);
            document.getElementById('readFilter').addEventListener('change', renderComics);
            document.getElementById('sortSelect').addEventListener('change', renderComics);
            document.getElementById('orderBtn').addEventListener('click', () => {
                isDescending = !isDescending;
                renderComics();
            });
        });


        function loadReadme() {
            // Update UI for Readme Mode
            document.getElementById('scroll-container').classList.add('hidden');
            document.getElementById('readme-container').classList.remove('hidden');

            // Deselect Sidebars
            document.querySelectorAll('[id^="btn-"]').forEach(el => {
                el.classList.remove('bg-[var(--bg-item-active)]', 'text-[var(--text-active)]');
                el.classList.add('text-[var(--text-main)]');
            });

            // Tab Header Styles
            document.getElementById('tab-main').classList.remove('border-t-2', 'border-[var(--accent)]', 'bg-[var(--bg-editor)]', 'text-[var(--text-main)]');
            document.getElementById('tab-main').classList.add('bg-[var(--bg-panel)]', 'text-[var(--text-muted)]', 'border-r', 'border-[var(--bg-sidebar)]'); // Inactive style

            document.getElementById('tab-readme').classList.add('bg-[var(--bg-editor)]', 'text-[var(--text-main)]', 'border-t-2', 'border-[var(--accent)]');
            document.getElementById('tab-readme').classList.remove('bg-[var(--bg-panel)]', 'text-[var(--text-muted)]', 'border-r');

            // Update Breadcrumbs
            document.getElementById('crumb-active').innerText = "README.md";
            document.getElementById('statsBar').innerText = "Markdown Preview";
        }

        function loadSheet(key) {
            // Hide Readme, Show Grid
            document.getElementById('readme-container').classList.add('hidden');
            document.getElementById('scroll-container').classList.remove('hidden');

            // Update Tab Header Styles
            document.getElementById('tab-readme').classList.remove('border-t-2', 'border-[var(--accent)]', 'bg-[var(--bg-editor)]', 'text-[var(--text-main)]');
            document.getElementById('tab-readme').classList.add('bg-[var(--bg-panel)]', 'text-[var(--text-muted)]', 'border-r', 'border-[var(--bg-sidebar)]');

            document.getElementById('tab-main').classList.add('bg-[var(--bg-editor)]', 'text-[var(--text-main)]', 'border-t-2', 'border-[var(--accent)]');
            document.getElementById('tab-main').classList.remove('bg-[var(--bg-panel)]', 'text-[var(--text-muted)]', 'border-r');

            currentTab = key;
            const grid = document.getElementById('comicGrid');

            // Update Active State in Sidebar
            document.querySelectorAll('[id^="btn-"]').forEach(el => {
                el.classList.remove('bg-[var(--bg-item-active)]', 'text-[var(--text-active)]');
                el.classList.add('text-[var(--text-main)]');
            });
            const activeBtn = document.getElementById(`btn-${key}`);
            activeBtn.classList.add('bg-[var(--bg-item-active)]', 'text-[var(--text-active)]');
            activeBtn.classList.remove('text-[var(--text-main)]');

            // Force Activity Bar to Defaults (Files)
            document.querySelectorAll('.activity-icon').forEach(i => i.classList.remove('text-[var(--text-active)]', 'border-l-2', 'border-[var(--text-active)]'));
            document.getElementById('icon-files').classList.add('text-[var(--text-active)]', 'border-l-2', 'border-[var(--text-active)]');

            // Update Breadcrumb & Tab (Also update icon color based on JS/JSON)
            const labels = { marvel: 'marvel_comics.js', dc: 'dc_universe.js', others: 'indie_reads.json' };
            document.getElementById('crumb-active').innerText = labels[key];
            document.getElementById('tab-main').querySelector('span').innerText = labels[key];

            grid.innerHTML = '';
            document.getElementById('loading').classList.remove('hidden');

            Papa.parse(sheetConfig[key], {
                download: true,
                header: true,
                complete: function (results) {
                    currentData = results.data;
                    document.getElementById('loading').classList.add('hidden');
                    renderComics();
                }
            });
        }

        function renderComics() {
            const grid = document.getElementById('comicGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('readFilter').value;
            const sortMode = document.getElementById('sortSelect').value;

            // Update Sort UI Indication
            const orderBtn = document.getElementById('orderBtn');
            orderBtn.innerHTML = isDescending
                ? `<i class="fa-solid fa-arrow-down-z-a"></i> toggle: desc`
                : `<i class="fa-solid fa-arrow-down-a-z"></i> toggle: asc`;

            grid.innerHTML = '';

            const filtered = currentData.filter(row => {
                if (!row.TITLE) return false;
                const textMatch = (row.TITLE + row.WRITER + row.CHARACTER).toLowerCase().includes(search);
                const isRead = (row.READ || '').toUpperCase() === 'TRUE';
                if (filter === 'read' && !isRead) return false;
                if (filter === 'unread' && isRead) return false;
                return textMatch;
            });

            // Sort logic
            filtered.sort((a, b) => {
                let res = 0;
                if (sortMode === 'title') res = (a.TITLE || '').localeCompare(b.TITLE || '');
                else if (sortMode === 'year') {
                    const getYear = s => (s || '').match(/\d{4}/) ? parseInt((s || '').match(/\d{4}/)[0]) : 0;
                    res = getYear(a.PUBLISH) - getYear(b.PUBLISH);
                }
                else if (sortMode === 'rating') res = (parseFloat(a.RATING) || -1) - (parseFloat(b.RATING) || -1);

                return isDescending ? -res : res;
            });

            document.getElementById('statsBar').innerText = `Objects: ${filtered.length}`;

            filtered.forEach(comic => {
                const isRead = (comic.READ || '').toUpperCase() === 'TRUE';

                // Code Block Card Style
                const div = document.createElement('div');
                div.className = "vscode-card p-0 border-l-[3px] border-[var(--accent)] hover:border-white transition group relative overflow-hidden";
                div.style.backgroundColor = "var(--bg-sidebar)";

                if (currentTab === 'marvel') div.style.borderColor = "var(--function)";
                if (currentTab === 'dc') div.style.borderColor = "var(--keyword)";

                div.innerHTML = `
                    ${comic.IMAGE ?
                        `<div class="h-32 overflow-hidden border-b" style="border-color: var(--border)">
                            <img src="${comic.IMAGE}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
                        </div>` : ''
                    }
                    
                    <div class="p-3 font-mono text-xs">
                        <div style="color: var(--keyword)" class="mb-1">class <span style="color: var(--type)">${(comic.TITLE || '').replace(/\\s+/g, '')}</span> {</div>
                        
                        <div class="pl-4 ml-1" style="border-left: 1px solid var(--border)">
                            <div><span style="color: var(--variable)">author</span>: <span style="color: var(--string)">"${comic.WRITER}"</span>;</div>
                            <div><span style="color: var(--variable)">year</span>: <span style="color: var(--number)">${(comic.PUBLISH || '').match(/\d{4}/)?.[0] || 'null'}</span>;</div>
                            <div><span style="color: var(--variable)">read</span>: <span style="color: var(--keyword)">${isRead}</span>;</div>
                            ${comic.RATING ? `<div><span style="color: var(--variable)">rating</span>: <span style="color: var(--number)">${comic.RATING}</span>;</div>` : ''}
                        </div>
                        
                        <div style="color: var(--keyword)" class="mt-1">}</div>
                    </div>
                    
                    <!-- Hover Action -->
                    ${comic.LINK ?
                        `<a href="${comic.LINK}" target="_blank" class="absolute top-2 right-2 px-2 py-1 bg-[#007acc] text-white text-xs opacity-0 group-hover:opacity-100 transition" style="background-color: var(--accent)">
                        <i class="fa-solid fa-external-link-alt"></i>
                    </a>` : ''}
                `;
                grid.appendChild(div);
            });
        }
    </script>
</body>

</html>